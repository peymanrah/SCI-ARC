# RLAN Large Configuration (~51M params)
# =======================================
# Full capacity RLAN for capacity scaling experiments
# 
# WARNING: NOT a fair comparison with TRM (~7M params)
# Use rlan_fair.yaml for parameter-matched comparison
#
# Purpose: Explore if more capacity helps ARC
# - Does 51M RLAN outperform 7M RLAN?
# - Is there a capacity ceiling for ARC?
#
# Module Scaling Rules:
#   num_heads = hidden_dim / 64 = 512 / 64 = 8
#   max_clues, num_predicates = task-specific (fixed)
#   msre/lcr params = positional encoding (fixed)
#
# Optimized for RTX 3090 (24GB VRAM), single GPU training

model:
  type: "rlan"
  hidden_dim: 512   # Full capacity (~51M params)
  num_colors: 10
  num_classes: 11   # TRM encoding: 0=boundary, 1-10=colors (shifted +1)
  max_grid_size: 30
  
  # Task-specific (NOT capacity-dependent) - same as other configs
  max_clues: 6       # Ceiling slightly above ARC max (~5) for generalization
  num_predicates: 8  # Covers most spatial relationships
  num_solver_steps: 6
  
  use_act: true  # Enable Adaptive Computation Time
  dropout: 0.1
  
  # Attention heads: hidden_dim / 64 = 512 / 64 = 8
  dsc_num_heads: 8
  lcr_num_heads: 8
  
  # Positional encoding (fixed, task-independent)
  msre_encoding_dim: 64
  msre_num_freq: 8
  lcr_num_freq: 8
  
  # Module ablation flags (all enabled for large model)
  use_context_encoder: true
  use_dsc: true
  use_msre: true
  use_lcr: true
  use_sph: true

training:
  max_epochs: 1000
  
  # =============================================================
  # BATCH SIZE STRATEGY FOR SINGLE RTX 3090 (24GB VRAM)
  # =============================================================
  # hidden_dim=512: ~500MB/sample with AMP + grads
  # Batch: 36 samples (~18GB VRAM, 6GB headroom for 51M model)
  # grad_accumulation=8 → effective_batch = 36 × 8 = 288
  # 
  # Slightly more headroom needed for larger model (EMA = 51M shadow)
  # =============================================================
  batch_size: 36
  grad_accumulation_steps: 8
  # effective_batch_size = 36 × 8 = 288
  
  learning_rate: 1.0e-4
  weight_decay: 0.1
  gradient_clip: 1.0
  
  # Temperature schedule
  temperature_start: 5.0
  temperature_end: 0.1
  
  # Loss weights - focal loss dominates
  focal_gamma: 2.0
  focal_alpha: 0.25
  lambda_entropy: 0.01
  lambda_sparsity: 0.001   # REDUCED from 0.005 to prevent DSC collapse
  lambda_predicate: 0.001
  lambda_curriculum: 0.01
  lambda_deep_supervision: 0.3
  
  # TRM numerical stability technique
  use_stablemax: true
  
  # =============================================================
  # CURRICULUM LEARNING: DISABLED (following TRM)
  # =============================================================
  # TRM trains on ALL tasks from epoch 1, relies on augmentation.
  # On-the-fly infinite augmentation is BETTER than curriculum.
  # =============================================================
  use_curriculum: false
  curriculum_stages: []
  
  # Optimizer & Scheduler (TRM settings)
  optimizer: "adamw"
  beta1: 0.9      # Adam momentum (standard)
  beta2: 0.95     # TRM uses 0.95 instead of default 0.999 for stability
  scheduler: "onecycle"
  warmup_epochs: 20
  min_lr: 1.0e-6
  
  # EMA for stable evaluation
  use_ema: true
  ema_decay: 0.999

data:
  train_path: "./data/arc-agi/data/training"
  eval_path: "./data/arc-agi/data/evaluation"
  
  max_grid_size: 30
  
  # Data loading optimization for 48 vCPU server
  # Use 24 workers (50% of vCPU) for on-the-fly augmentation
  num_workers: 24
  pin_memory: true
  prefetch_factor: 4
  persistent_workers: true
  
  # Infinite diversity mode
  cache_samples: false
  
  # Full augmentation pipeline
  augmentation:
    enabled: true
    rotation: true
    flip: true
    transpose: true
    color_permutation: true  # 9! = 362,880 permutations
    translational: true      # TRM-style random offset in 30×30 canvas

evaluation:
  num_guesses: 2
  use_tta: true
  tta_rotations: [0, 90, 180, 270]
  tta_flips: [false, true]

logging:
  log_every: 1
  save_every: 25
  eval_every: 5
  keep_last_n: 5
  checkpoint_dir: "checkpoints/rlan_large"
  log_to_file: true
  
  # Augmentation diversity tracking (CRITICAL for debugging)
  # Enables per-epoch logging of transformation distribution
  # Verifies on-the-fly augmentation is truly random and uniform
  track_augmentation: true
  
  use_wandb: false
  wandb_project: "rlan-arc"
  wandb_run_name: null

# Hardware settings
hardware:
  device: "cuda"
  seed: 42
  deterministic: false

device:
  use_cuda: true
  mixed_precision: true   # AMP required for 51M model
  dtype: "bfloat16"
  compile: false
